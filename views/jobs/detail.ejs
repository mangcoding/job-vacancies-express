
<div id="loading" class="text-center py-8 text-gray-600">Loading job details...</div>
<div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>

<div id="auth-required" class="flex justify-center items-center min-h-[400px] hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-gray-900">Authentication Required</h2>
    <p class="text-gray-600 mb-6">Please login or register to view job details and apply.</p>
    <div class="space-x-4">
      <a href="/auth/login" class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Login</a>
      <a href="/auth/register" class="inline-block bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition">Register</a>
    </div>
  </div>
</div>

<div id="job-detail" class="hidden">
  <div class="mb-8">
    <h1 id="job-title" class="text-4xl font-bold text-gray-900 mb-4"></h1>
    <div class="flex flex-wrap gap-4 text-gray-600">
      <span id="job-company" class="font-medium"></span>
      <span id="job-location"></span>
      <span id="job-salary"></span>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-md p-8">
    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-gray-900 border-b-2 border-gray-200 pb-2">Description</h2>
      <div id="job-description" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></div>
    </section>

    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-gray-900 border-b-2 border-gray-200 pb-2">Requirements</h2>
      <div id="job-requirements" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></div>
    </section>

    <section id="apply-section" class="hidden">
      <h2 class="text-2xl font-semibold mb-4 text-gray-900 border-b-2 border-gray-200 pb-2">Apply for this Position</h2>
      <form id="apply-form" class="space-y-4">
        <div>
          <label for="cover-letter" class="block mb-2 text-sm font-medium text-gray-700">Cover Letter</label>
          <textarea 
            id="cover-letter" 
            name="coverLetter" 
            rows="6" 
            placeholder="Tell us why you're a great fit for this position..."
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          ></textarea>
        </div>
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Submit Application</button>
        <div id="apply-message" class="hidden px-4 py-3 rounded"></div>
      </form>
    </section>

    <div id="already-applied" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded hidden">
      <p>âœ“ You have already applied for this position.</p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const jobId = '<%= jobId %>';
    await loadJobDetail(jobId);
  });

  async function loadJobDetail(jobId) {
    try {
      document.getElementById('loading').classList.remove('hidden');
      
      const token = localStorage.getItem('token');
      
      if (!token) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('auth-required').classList.remove('hidden');
        return;
      }

      const response = await fetch(`/api/vacancies/${jobId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('auth-required').classList.remove('hidden');
        updateAuthUI();
        return;
      }

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Failed to load job details');
      }

      const job = await response.json();
      displayJobDetail(job);
      
      // Check if user already applied
      await checkApplicationStatus(jobId);
      
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('job-detail').classList.remove('hidden');
    } catch (error) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error-message').classList.remove('hidden');
      document.getElementById('error-message').textContent = error.message;
    }
  }

  function displayJobDetail(job) {
    document.getElementById('job-title').textContent = escapeHtml(job.title);
    document.getElementById('job-company').textContent = escapeHtml(job.company);
    document.getElementById('job-location').textContent = `ðŸ“ ${escapeHtml(job.location)}`;
    document.getElementById('job-salary').textContent = job.salary ? `ðŸ’° ${escapeHtml(job.salary)}` : '';
    document.getElementById('job-description').innerHTML = formatText(job.description);
    document.getElementById('job-requirements').innerHTML = formatText(job.requirements);
    
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.role === 'MEMBER' && job.status === 'ACTIVE') {
      document.getElementById('apply-section').classList.remove('hidden');
    }
  }

  async function checkApplicationStatus(jobId) {
    try {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if (user.role !== 'MEMBER') return;

      const response = await fetch('/api/member/applications', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        const hasApplied = data.applications.some(app => app.jobVacancyId === parseInt(jobId));
        
        if (hasApplied) {
          document.getElementById('apply-section').classList.add('hidden');
          document.getElementById('already-applied').classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Error checking application status:', error);
    }
  }

  document.getElementById('apply-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const jobId = '<%= jobId %>';
    const coverLetter = document.getElementById('cover-letter').value;
    const messageEl = document.getElementById('apply-message');
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/vacancies/${jobId}/apply`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ coverLetter })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to submit application');
      }

      messageEl.classList.remove('hidden');
      messageEl.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded';
      messageEl.textContent = 'âœ“ Application submitted successfully!';
      document.getElementById('apply-form').reset();
      document.getElementById('apply-section').classList.add('hidden');
      document.getElementById('already-applied').classList.remove('hidden');
    } catch (error) {
      messageEl.classList.remove('hidden');
      messageEl.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
      messageEl.textContent = error.message;
    }
  });

  function formatText(text) {
    return escapeHtml(text).replace(/\n/g, '<br>');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
