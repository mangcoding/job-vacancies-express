<div class="admin-header">
  <h1><%= title %></h1>
  <a href="/admin/users" class="btn-secondary">‚Üê Back to Users</a>
</div>

<div id="loading" class="loading" style="display: none;">Loading...</div>
<div id="error-message" class="error-message" style="display: none;"></div>

<div class="form-container">
  <form id="user-form" class="admin-form">
    <div class="form-group">
      <label for="name">Full Name *</label>
      <input type="text" id="name" name="name" required>
    </div>

    <div class="form-group">
      <label for="email">Email *</label>
      <input type="email" id="email" name="email" required>
    </div>

    <div class="form-group">
      <label for="password"><%= userId ? 'New Password (leave blank to keep current)' : 'Password *' %></label>
      <input type="password" id="password" name="password" <%= userId ? '' : 'required' %> minlength="6">
    </div>

    <div class="form-group">
      <label for="role">Role *</label>
      <select id="role" name="role" required>
        <option value="MEMBER">Member</option>
        <option value="ADMIN">Admin</option>
      </select>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Save User</button>
      <a href="/admin/users" class="btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  const userId = '<%= userId || "" %>';

  document.addEventListener('DOMContentLoaded', async () => {
    if (userId) {
      await loadUser(userId);
    }
  });

  async function loadUser(id) {
    try {
      document.getElementById('loading').style.display = 'block';
      const token = localStorage.getItem('token');
      
      const response = await fetch(`/api/admin/users/${id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        throw new Error('Failed to load user');
      }

      const user = await response.json();
      document.getElementById('name').value = user.name;
      document.getElementById('email').value = user.email;
      document.getElementById('role').value = user.role;
      
      document.getElementById('loading').style.display = 'none';
    } catch (error) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').textContent = error.message;
    }
  }

  document.getElementById('user-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      role: document.getElementById('role').value
    };

    const password = document.getElementById('password').value;
    if (password) {
      formData.password = password;
    }

    try {
      document.getElementById('error-message').style.display = 'none';
      const token = localStorage.getItem('token');
      
      const url = userId ? `/api/admin/users/${userId}` : '/api/admin/users';
      const method = userId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to save user');
      }

      alert(userId ? 'User updated successfully' : 'User created successfully');
      window.location.href = '/admin/users';
    } catch (error) {
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').textContent = error.message;
    }
  });
</script>
