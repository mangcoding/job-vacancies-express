<div class="admin-header">
  <h1><%= title %></h1>
  <a href="/admin/vacancies" class="btn-secondary">‚Üê Back to Vacancies</a>
</div>

<div id="loading" class="loading" style="display: none;">Loading...</div>
<div id="error-message" class="error-message" style="display: none;"></div>

<div class="form-container">
  <form id="vacancy-form" class="admin-form">
    <div class="form-group">
      <label for="title">Job Title *</label>
      <input type="text" id="title" name="title" required>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="company">Company *</label>
        <input type="text" id="company" name="company" required>
      </div>
      <div class="form-group">
        <label for="location">Location *</label>
        <input type="text" id="location" name="location" required>
      </div>
    </div>

    <div class="form-group">
      <label for="salary">Salary</label>
      <input type="text" id="salary" name="salary" placeholder="e.g., $50,000 - $70,000">
    </div>

    <div class="form-group">
      <label for="description">Description *</label>
      <textarea id="description" name="description" rows="6" required></textarea>
    </div>

    <div class="form-group">
      <label for="requirements">Requirements *</label>
      <textarea id="requirements" name="requirements" rows="6" required></textarea>
    </div>

    <div class="form-group">
      <label for="status">Status *</label>
      <select id="status" name="status" required>
        <option value="ACTIVE">Active</option>
        <option value="CLOSED">Closed</option>
      </select>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Save Job Vacancy</button>
      <a href="/admin/vacancies" class="btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  const vacancyId = '<%= vacancyId || "" %>';

  document.addEventListener('DOMContentLoaded', async () => {
    if (vacancyId) {
      await loadVacancy(vacancyId);
    }
  });

  async function loadVacancy(id) {
    try {
      document.getElementById('loading').style.display = 'block';
      const token = localStorage.getItem('token');
      
      const response = await fetch(`/api/admin/vacancies/${id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
        throw new Error('Failed to load vacancy');
      }

      const vacancy = await response.json();
      document.getElementById('title').value = vacancy.title;
      document.getElementById('company').value = vacancy.company;
      document.getElementById('location').value = vacancy.location;
      document.getElementById('salary').value = vacancy.salary || '';
      document.getElementById('description').value = vacancy.description;
      document.getElementById('requirements').value = vacancy.requirements;
      document.getElementById('status').value = vacancy.status;
      
      document.getElementById('loading').style.display = 'none';
    } catch (error) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').textContent = error.message;
    }
  }

  document.getElementById('vacancy-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
      title: document.getElementById('title').value,
      company: document.getElementById('company').value,
      location: document.getElementById('location').value,
      salary: document.getElementById('salary').value || null,
      description: document.getElementById('description').value,
      requirements: document.getElementById('requirements').value,
      status: document.getElementById('status').value
    };

    try {
      document.getElementById('error-message').style.display = 'none';
      const token = localStorage.getItem('token');
      
      const url = vacancyId ? `/api/admin/vacancies/${vacancyId}` : '/api/admin/vacancies';
      const method = vacancyId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to save vacancy');
      }

      alert(vacancyId ? 'Job vacancy updated successfully' : 'Job vacancy created successfully');
      window.location.href = '/admin/vacancies';
    } catch (error) {
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').textContent = error.message;
    }
  });
</script>
