<div class="admin-header">
  <div>
    <h1>Manage Job Vacancies</h1>
    <p>Create and manage job postings</p>
  </div>
  <a href="/admin/vacancies/new" class="btn-primary">+ Create Job</a>
</div>

<div id="loading" class="loading">Loading vacancies...</div>
<div id="error-message" class="error-message" style="display: none;"></div>

<div class="filters">
  <select id="status-filter" class="filter-select">
    <option value="">All Status</option>
    <option value="ACTIVE">Active</option>
    <option value="CLOSED">Closed</option>
  </select>
  <button onclick="loadVacancies()" class="btn-secondary">Filter</button>
</div>

<table class="admin-table" id="vacancies-table" style="display: none;">
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Company</th>
      <th>Location</th>
      <th>Status</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="vacancies-tbody">
  </tbody>
</table>

<div id="pagination" class="pagination" style="display: none;"></div>

<script>
  let currentPage = 1;

  document.addEventListener('DOMContentLoaded', () => {
    loadVacancies();
  });

  async function loadVacancies(page = 1) {
    try {
      currentPage = page;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error-message').style.display = 'none';
      
      const token = localStorage.getItem('token');
      const statusFilter = document.getElementById('status-filter').value;
      const params = new URLSearchParams({ page, limit: 10 });
      if (statusFilter) params.append('status', statusFilter);

      const response = await fetch(`/api/admin/vacancies?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.status === 401 || response.status === 403) {
        window.location.href = '/auth/login';
        return;
      }

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load vacancies');
      }

      displayVacancies(data.vacancies);
      displayPagination(data.pagination);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('vacancies-table').style.display = 'table';
    } catch (error) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').textContent = error.message;
    }
  }

  function displayVacancies(vacancies) {
    const tbody = document.getElementById('vacancies-tbody');
    if (vacancies.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">No vacancies found</td></tr>';
      return;
    }

    tbody.innerHTML = vacancies.map(vacancy => `
      <tr>
        <td>${vacancy.id}</td>
        <td>${escapeHtml(vacancy.title)}</td>
        <td>${escapeHtml(vacancy.company)}</td>
        <td>${escapeHtml(vacancy.location)}</td>
        <td><span class="badge badge-${vacancy.status === 'ACTIVE' ? 'active' : 'closed'}">${vacancy.status}</span></td>
        <td>${new Date(vacancy.createdAt).toLocaleDateString()}</td>
        <td>
          <a href="/admin/vacancies/${vacancy.id}/edit" class="btn-sm btn-secondary">Edit</a>
          <a href="/admin/vacancies/${vacancy.id}/applications" class="btn-sm btn-primary">Applications</a>
          <button onclick="deleteVacancy(${vacancy.id})" class="btn-sm btn-danger">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  function displayPagination(pagination) {
    if (pagination.totalPages <= 1) {
      document.getElementById('pagination').style.display = 'none';
      return;
    }

    const paginationEl = document.getElementById('pagination');
    paginationEl.style.display = 'flex';
    
    let html = '';
    if (pagination.page > 1) {
      html += `<button onclick="loadVacancies(${pagination.page - 1})">Previous</button>`;
    }
    html += `<span>Page ${pagination.page} of ${pagination.totalPages}</span>`;
    if (pagination.page < pagination.totalPages) {
      html += `<button onclick="loadVacancies(${pagination.page + 1})">Next</button>`;
    }
    paginationEl.innerHTML = html;
  }

  async function deleteVacancy(vacancyId) {
    if (!confirm('Are you sure you want to delete this job vacancy?')) return;

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/admin/vacancies/${vacancyId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to delete vacancy');
      }

      alert('Job vacancy deleted successfully');
      loadVacancies(currentPage);
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
