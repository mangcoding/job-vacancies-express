<div class="flex justify-between items-center mb-8 flex-wrap gap-4">
  <div>
    <h1 class="text-4xl font-bold text-gray-900 mb-2">Manage Users</h1>
    <p class="text-gray-600 text-lg">View and manage all users</p>
  </div>
  <a href="/admin/users/new" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">+ Create User</a>
</div>

<div id="loading" class="text-center py-8 text-gray-600">Loading users...</div>
<div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>

<div class="flex gap-4 items-center mb-6">
  <select id="role-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
    <option value="">All Roles</option>
    <option value="ADMIN">Admin</option>
    <option value="MEMBER">Member</option>
  </select>
  <button onclick="loadUsers()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">Filter</button>
</div>

<div class="bg-white rounded-lg shadow-md overflow-hidden">
  <table class="min-w-full divide-y divide-gray-200" id="users-table">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
      </tr>
    </thead>
    <tbody id="users-tbody" class="bg-white divide-y divide-gray-200">
    </tbody>
  </table>
</div>

<div id="pagination" class="flex justify-center items-center gap-4 mt-8 hidden"></div>

<script>
  let currentPage = 1;

  document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
  });

  async function loadUsers(page = 1) {
    try {
      currentPage = page;
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('error-message').classList.add('hidden');
      
      const token = localStorage.getItem('token');
      const roleFilter = document.getElementById('role-filter').value;
      const params = new URLSearchParams({ page, limit: 10 });
      if (roleFilter) params.append('role', roleFilter);

      const response = await fetch(`/api/admin/users?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.status === 401 || response.status === 403) {
        window.location.href = '/auth/login';
        return;
      }

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load users');
      }

      displayUsers(data.users);
      displayPagination(data.pagination);
      document.getElementById('loading').classList.add('hidden');
    } catch (error) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error-message').classList.remove('hidden');
      document.getElementById('error-message').textContent = error.message;
    }
  }

  function displayUsers(users) {
    const tbody = document.getElementById('users-tbody');
    if (users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
      return;
    }

    tbody.innerHTML = users.map(user => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(user.name)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(user.email)}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'ADMIN' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString()}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
          <a href="/admin/users/${user.id}/edit" class="text-blue-600 hover:text-blue-900">Edit</a>
          <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  function displayPagination(pagination) {
    if (pagination.totalPages <= 1) {
      document.getElementById('pagination').classList.add('hidden');
      return;
    }

    const paginationEl = document.getElementById('pagination');
    paginationEl.classList.remove('hidden');
    
    let html = '';
    if (pagination.page > 1) {
      html += `<button onclick="loadUsers(${pagination.page - 1})" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Previous</button>`;
    }
    html += `<span class="text-gray-600">Page ${pagination.page} of ${pagination.totalPages}</span>`;
    if (pagination.page < pagination.totalPages) {
      html += `<button onclick="loadUsers(${pagination.page + 1})" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Next</button>`;
    }
    paginationEl.innerHTML = html;
  }

  async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/admin/users/${userId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to delete user');
      }

      alert('User deleted successfully');
      loadUsers(currentPage);
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
